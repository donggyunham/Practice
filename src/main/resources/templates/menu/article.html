<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{layout :: head('Practice')}">
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body th:replace="~{layout :: base(~{::section})}">
    <section>
        <div>
            <h2>뉴스 기사 관리</h2>
            <!-- fs 폰트크기, text-muted 회색 -->
            <span class="text-muted fs-5">
                / 전체 기사 개수 : <span th:text="${articleCount}"></span> 개
            </span>
        </div>

        <hr>

        <!-- 에러메시지 -->
        <div th:if="${error}" class="alert alert-danger" th:text="${error}"></div>

        <div>
            <!-- 링크는 @ 타임리프 문법 -->
            <!-- form태그는 로그인 같은 것을 주로 처리하는데 사용 -->
            <form th:action="@{/inputArticle}" method="post" class="d-flex align-items-center gap-2">
                <label for="categorySelect" class="form-label mb-0 me-2">최신</label>
                <!-- 드롭다운 박스, 콤보 박스 -->
                <!-- name은 controller와 연결되는 변수로 사용 -->
                <select id="categorySelect" name="categoryName" class="form-select w-auto">
                    <option th:each="cat, iterStat : ${categories}"
                            th:value="${cat.name}"
                            th:text="${cat.name}"
                            th:selected="${iterStat.index == 0}">
                    </option>
                </select>
                <span class="me-2">카테고리 기사들을</span>
                <input type="submit" class="btn btn-outline-primary" value="일괄 입력하기">
            </form>
        </div>

        <hr>

        <div class="fs-5 border bg-dark-subtle rounded text-dark p-1 mb-1" style="width:100%;">카테고리별 기사수</div>
        <div class="row g-3 align-items-stretch">
            <div class="col-12 col-md-6">
                <div class="h-100 p-3 text-bg-light border border-secondary rounded" style="--bs-border-opacity: .2;">
                    <table class="table table-striped table-hover" id="categoryTable">
                        <thead class="table-dark">
                        <tr>
                            <th scope="col">카테고리명</th>
                            <th scope="col">기사수</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:each="count : ${countsByCategory}">
                            <td th:text="${count.category}"></td>
                            <td th:text="${count.count}"></td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="col-12 col-md-6">
                <div class="h-100 d-flex justify-content-center align-items-center text-bg-light border border-secondary rounded" style="--bs-border-opacity: .2;">
                    <canvas id="categoryChart" style="max-width:460px; max-height:300px;"></canvas>
                </div>
            </div>
        </div>

        <!-- chart module 불러오기 -->
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <!-- chart plugin moduel 불러오기 -->
        <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>

        <script>
            // chart.js 라이브러리 사용.
            // HTML 문서의 모든 요소가 로드된 후 실행될 함수 등록
            document.addEventListener(
                "DOMContentLoaded", () => {

                // id가 categoryTable인 <table> 요소를 javascript 객체로 가져옴, 카테고리명, 개수 읽어옴.
                const table = document.getElementById("categoryTable");

                // 차트에 들어갈 데이터 배열 준비.
                const labels = []; // category name
                const data = []; // count data

                // pie 차트를 그릴 데이터를 준비
                // 테이블의 <tbody> 안에 있는 모든 <tr>(행)을 순회(loop).
                // 한 행에 해당하는 카테고리 데이터 하나씩 처리.
                table.querySelectorAll("tbody tr").forEach(row => {

                    // 첫번째 열(카테고리명)
                    const category = row.cells[0].innerText.trim();
                    // 두번째 열(개수) innerText로 글자 읽고, trim으로 공백제거, parseInt(,10) 문자열 숫자로 변환.
                    const count = parseInt(row.cells[1].innerText.trim(), 10);

                    // 읽어온 데이터 labels와 data 배열에 추가.
                    labels.push(category);
                    data.push(count);
                });

                // <canvas id = "categoryChart"> 요소의 2d그래픽 컨텍스트? 를 가져옴. 하여튼 여기다 차트그릴거라는거임.
                const ctx = document.getElementById("categoryChart").getContext("2d");

                // datalabels plugin 등록 chart.js의 플러그인중 하나인 ChartDataLabels를 등록. 각 파이 조각에 라벨 표시.
                Chart.register(ChartDataLabels);

                // 새로운 chart.js 객체 생성
                new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: [
                                '#ff6384', '#36a2eb', '#ffcd56', '#4bc0c0', '#9966ff',
                                '#ff9f40', '#8bc34a', '#e91e63', '#00bcd4', '#9c27b0'
                            ],
                            borderColor: '#fff',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        layout: { padding: 30 },
                        plugins: {
                            legend: { display: false },
                            datalabels: {
                                color: '#000',
                                formatter: (value, ctx) => {
                                    const label = ctx.chart.data.labels[ctx.dataIndex];
                                    return `${label} (${value})`;
                                },
                                anchor: 'end',
                                align: 'end',
                                offset: 10
                            }
                        }
                    }
                });
            });
        </script>
    </section>
</body>
</html>